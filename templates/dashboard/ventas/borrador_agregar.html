{% extends 'base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block title %}Venta en Borrador{% endblock %}

{% block content %}
<div class="mt-4">
  {% if messages %}
    <div class="mb-4">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="font-semibold">Venta en Borrador</h1>
  </div>

  <!-- Formulario para agregar/actualizar detalle -->
  <form method="post" action="{% url 'ventas:borrador_agregar' %}" class="row g-2 align-items-end mb-4">
    {% csrf_token %}
    <div class="col-auto">
      <label for="producto_talla" class="form-label">Producto:</label>
      <select id="producto_talla" name="producto_talla" class="form-select" required>
        <option value="" disabled {% if not request.POST.producto_talla %}selected{% endif %}>Selecciona...</option>
        {% for pt in producto_tallas %}
          <option value="{{ pt.id }}">
            {{ pt.producto.nombre }} – Talla {{ pt.talla }} (${{ pt.producto.precio|floatformat:0 }})
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label for="cantidad" class="form-label">Cantidad:</label>
      <input type="number" id="cantidad" name="cantidad" min="1" value="1" class="form-control" required>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Agregar / Actualizar</button>
    </div>
  </form>

  <!-- Tabla de detalles borrador -->
  <div class="table-responsive mb-4">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for d in object.detalles.all %}
          <tr>
            <td>{{ d.producto_talla.producto.nombre }} (Talla {{ d.producto_talla.talla }})</td>
            <td>{{ d.cantidad }}</td>
            <td>${{ d.subtotal|intcomma }}</td>
            <td>
              <a href="{% url 'ventas:borrador_eliminar' d.pk %}" class="btn btn-sm btn-danger">Eliminar</a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-center">No hay productos agregados.</td>
          </tr>
        {% endfor %}
      </tbody>
      {% if object.detalles.exists %}
      <tfoot>
        <tr>
          <td colspan="2" class="text-end"><strong>Total:</strong></td>
          <td colspan="2"><strong>${{ object.total|intcomma }}</strong></td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>

  <!-- Formulario para finalizar venta -->
  <form method="post" action="{% url 'ventas:borrador_finalizar' %}" class="row g-2 align-items-end">
    {% csrf_token %}
    <div class="col-auto">
      <label for="metodo_pago" class="form-label">Método de Pago:</label>
      <select id="metodo_pago" name="metodo_pago" class="form-select" required>
        <option value="" disabled selected>Selecciona...</option>
        {% for code, label in METODOS_PAGO %}
          <option value="{{ code }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-success">Finalizar Venta</button>
    </div>
  </form>
</div>
{% endblock %}
