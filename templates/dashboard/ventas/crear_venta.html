{% extends 'base_dashboard.html' %}
{% load static %}
{% block content %}
<div class="container mt-5">
    <h4 class="fw-semibold mb-3">Realizar Venta</h4>
    <form method="post" id="venta-form" action="{% url 'ventas:crear_venta' %}">
        {% csrf_token %}

        <!-- Campo de Código de Barras -->
        <div class="input-group mb-3">
            <input type="text" id="codigo_barras" name="codigo_barras" class="form-control border-black shadow-sm"
                placeholder="Escanear o ingresar código de barras" aria-label="Código de Barras">
            <button type="button" class="btn btn-success border-black" id="btn-agregar-producto" onclick="buscarProducto()">Agregar Producto</button>
        </div>

        <div class="container border border-2 shadow p-3 rounded-4">
            <!-- Listado de Productos en la Venta -->
            <div class="table-responsive mt-3">
                <table id="productos-table" class="table table-bordered table-striped table-hover">
                    <thead class="thead-dark">
                        <tr class="text-center align-middle">
                            <th>Producto</th>
                            <th>Color</th>
                            <th>Género</th>
                            <th>Talla</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productos-list">
                        <!-- Los productos se agregarán aquí -->
                    </tbody>
                </table>
            </div>

            <!-- Selector de Método de Pago -->
            <div class="mb-3">
                <label for="metodo_pago" class="form-label fw-semibold">Método de Pago</label>
                <select id="metodo_pago" name="metodo_pago" class="form-select border-black shadow-sm" required>
                    <option value="" disabled selected>Selecciona un método de pago</option>
                    {% for valor, nombre in metodos_pago %}
                        <option value="{{ valor }}">{{ nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Total de la Venta -->
            <h5 class="mt-4">Total de esta Venta: <span id="total-venta" class="badge bg-success">$0</span></h5>

            <button type="submit" class="btn btn-primary border-black mt-4">Terminar Venta</button>
        </div>
    </form>
</div>

{% if messages %}
<!-- Modal de Mensajes -->
<div class="modal fade" id="mensajeModal" tabindex="-1" aria-labelledby="mensajeModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border border-2 border-danger shadow">
    <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="mensajeModalLabel">Error</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
    </div>
    <div class="modal-body">
        {% for message in messages %}
        <p class="mb-0">{{ message }}</p>
        {% endfor %}
    </div>
    </div>
</div>
</div>

<script>
    const modal = new bootstrap.Modal(document.getElementById('mensajeModal'));
    modal.show();

    // Cerrar automáticamente después de 4 segundos
    setTimeout(() => {
        modal.hide();
    }, 4000);
</script>
{% endif %}


<script>
  // Formateador COP sin decimales
  const formatter = new Intl.NumberFormat('es-CO', {
    style: 'currency', currency: 'COP',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  });

  let totalVenta = 0;

  // Al presionar Enter en el input de código de barras
  document.getElementById('codigo_barras')
          .addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      buscarProducto();
    }
  });

  // Llama a tu vista que devuelve JSON con datos de producto
  function buscarProducto() {
    const input = document.getElementById('codigo_barras');
    const codigo = input.value.trim();
    if (!codigo) {
      alert('Ingresa un código de barras válido');
      return;
    }
    fetch(`{% url 'ventas:obtener_producto_por_codigo' %}?codigo_barras=${codigo}`)
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          agregarProducto(data.producto);
        } else {
          alert(data.message);
        }
      })
      .catch(() => alert('Error al buscar el producto'))
      .finally(() => input.value = '');
  }

  // Añade una fila nueva o incrementa cantidad
  function agregarProducto(prod) {
    const tbody = document.getElementById('productos-list');
    // Busca si ya existe
    let fila = Array.from(tbody.children)
      .find(r => r.dataset.id == prod.id);

    if (fila) {
      const cantInput = fila.querySelector('input[name="cantidades"]');
      let nueva = Math.min(prod.stock, parseInt(cantInput.value) + 1);
      cantInput.value = nueva;
      actualizarFila(fila);
      return;
    }

    if (prod.stock <= 0) {
      alert(`Sin stock: ${prod.nombre}`);
      return;
    }

    // Crea fila
    fila = document.createElement('tr');
    fila.dataset.id    = prod.id;
    fila.dataset.stock = prod.stock;

    fila.innerHTML = `
      <td class="align-middle text-wrap">
        ${prod.nombre}
        <input type="hidden" name="productos_ids" value="${prod.id}">
      </td>
      <td class="text-center align-middle">${prod.color}</td>
      <td class="text-center align-middle">${prod.genero}</td>
      <td class="text-center align-middle">${prod.talla}</td>
      <td class="text-center align-middle">
        <input type="number"
               name="precios"
               class="form-control precio-input text-end"
               step="1"
               min="0"
               value="${prod.precio}"
               onchange="onPrecioChange(this)">
      </td>
      <td class="text-center align-middle">
        <input type="number"
               name="cantidades"
               class="form-control cantidad-input text-center"
               value="1"
               min="1"
               max="${prod.stock}"
               onchange="onCantidadChange(this)">
      </td>
      <td class="text-center align-middle total-cell">
        ${formatter.format(prod.precio)}
      </td>
      <td class="text-center align-middle">
        <button type="button" class="btn btn-sm btn-danger"
                onclick="eliminarProducto(this)">
          Eliminar
        </button>
      </td>
    `;
    tbody.appendChild(fila);
    totalVenta += prod.precio;
    document.getElementById('total-venta').textContent = formatter.format(totalVenta);
  }

  // Cuando cambia la cantidad
  function onCantidadChange(input) {
    const fila  = input.closest('tr');
    const max   = parseInt(fila.dataset.stock);
    let val     = parseInt(input.value) || 1;
    if (val < 1) val = 1;
    if (val > max) {
      alert(`Máximo disponible: ${max}`);
      val = max;
    }
    input.value = val;
    actualizarFila(fila);
  }

  // Cuando cambia el precio
  function onPrecioChange(input) {
    const val = parseFloat(input.value) || 0;
    if (val < 0) input.value = 0;
    actualizarFila(input.closest('tr'));
  }

  // Elimina la fila
  function eliminarProducto(btn) {
    const fila = btn.closest('tr');
    const totalCell = fila.querySelector('.total-cell');
    const valor      = parseFloat(totalCell.textContent.replace(/[^0-9]/g, '')) || 0;
    totalVenta     -= valor;
    document.getElementById('total-venta').textContent = formatter.format(totalVenta);
    fila.remove();
  }

  // Recalcula subtotal de la fila y totalVenta
  function actualizarFila(fila) {
    const cantidad = parseInt(fila.querySelector('.cantidad-input').value) || 0;
    const precio   = parseFloat(fila.querySelector('.precio-input').value) || 0;
    const subtotal = cantidad * precio;
    // Ajusta totalVenta: sumamos el cambio (nuevo - viejo)
    const viejaCelda = parseFloat(fila.querySelector('.total-cell')
                          .textContent.replace(/[^0-9]/g, '')) || 0;
    totalVenta += subtotal - viejaCelda;
    // Actualiza celdas
    fila.querySelector('.total-cell').textContent = formatter.format(subtotal);
    document.getElementById('total-venta').textContent = formatter.format(totalVenta);
  }
</script>

<script>
    document.getElementById('venta-form').addEventListener('submit', function() {
        // Deshabilita el botón de submit
        this.querySelector('button[type="submit"]').disabled = true;
    });
    </script>
    

{% endblock %}
