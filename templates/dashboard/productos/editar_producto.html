{% extends 'base_dashboard.html' %}
{% load custom_filters %}
{% load heroicons %}
{% load static %}

{% with icon_color='text-emerald-600' %}
{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6 overflow-x-hidden">
  <form id="productoForm" method="post" enctype="multipart/form-data" class="space-y-6">
    {% csrf_token %}

    <header class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-gray-900">Editar Producto</h1>
        <p class="text-sm text-gray-500 mt-1">Completa la información para actualizar el producto.</p>
      </div>

      <div class="flex items-center gap-2">
        <a href="{% url 'contenido_productos' %}" class="px-3 py-2 rounded-md border border-gray-200 text-gray-700 hover:bg-gray-50">Volver</a>
        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md shadow">
          Guardar
        </button>
      </div>
    </header>


    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Form principal (2/3) -->
      <div class="lg:col-span-2 space-y-6">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {# NOMBRE #}
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">{{ form.nombre.label }}</label>
            <div class="flex items-center bg-white border rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-emerald-300">
              <span class="px-3 text-gray-400">
                <i class="{{ form.nombre.field.widget.attrs.icon|default:'bi bi-question-circle' }} {{ icon_color }} text-lg"></i>
              </span>
              {{ form.nombre|add_class:"w-full p-3 rounded-r-lg bg-transparent focus:outline-none" }}
            </div>
            {% if form.nombre.errors %}
              <p class="mt-1 text-xs text-red-600">{% for e in form.nombre.errors %}{{ e }} {% endfor %}</p>
            {% endif %}
          </div>

          {# REFERENCIA #}
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">{{ form.referencia.label }}</label>
            <div class="flex items-center bg-white border rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-emerald-300">
              <span class="px-3 text-gray-400">
                <i class="{{ form.referencia.field.widget.attrs.icon|default:'bi bi-hash' }} {{ icon_color }} text-lg"></i>
              </span>
              {{ form.referencia|add_class:"w-full p-3 rounded-r-lg bg-transparent focus:outline-none" }}
            </div>
            {% if form.referencia.errors %}<p class="mt-1 text-xs text-red-600">{% for e in form.referencia.errors %}{{ e }} {% endfor %}</p>{% endif %}
          </div>
        </div>

        {# DESCRIPCION #}
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-2">{{ form.descripcion.label }}</label>
          <div class="bg-white border rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-emerald-300">
            <div class="flex items-start px-3 py-2 text-gray-400">
              <i class="{{ form.descripcion.field.widget.attrs.icon|default:'bi bi-journal-text' }} {{ icon_color }} text-lg"></i>
            </div>
            {{ form.descripcion|add_class:"w-full p-3 bg-transparent focus:outline-none rounded-b-lg" }}
          </div>
          {% if form.descripcion.errors %}<p class="mt-1 text-xs text-red-600">{% for e in form.descripcion.errors %}{{ e }} {% endfor %}</p>{% endif %}
        </div>

        {# PRECIOS + CATEGORIA #}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">{{ form.precio_compra.label }}</label>
            <div class="flex items-center bg-white border rounded-lg shadow-sm">
              <span class="px-3 text-gray-400"><i class="{{ form.precio_compra.field.widget.attrs.icon|default:'bi bi-cash-stack' }} {{ icon_color }} text-lg"></i></span>
              {{ form.precio_compra|add_class:"w-full p-3 rounded-r-lg bg-transparent precio-input" }}
            </div>
            {% if form.precio_compra.errors %}<p class="mt-1 text-xs text-red-600">{% for e in form.precio_compra.errors %}{{ e }} {% endfor %}</p>{% endif %}
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">{{ form.precio_venta.label }}</label>
            <div class="flex items-center bg-white border rounded-lg shadow-sm">
              <span class="px-3 text-gray-400"><i class="{{ form.precio_venta.field.widget.attrs.icon|default:'bi bi-currency-dollar' }} {{ icon_color }} text-lg"></i></span>
              {{ form.precio_venta|add_class:"w-full p-3 rounded-r-lg bg-transparent precio-input" }}
            </div>
            {% if form.precio_venta.errors %}<p class="mt-1 text-xs text-red-600">{% for e in form.precio_venta.errors %}{{ e }} {% endfor %}</p>{% endif %}
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">{{ form.categoria.label }}</label>
            <div class="bg-white border rounded-lg shadow-sm">
              <div class="flex items-center px-3">
                <i class="{{ form.categoria.field.widget.attrs.icon|default:'bi bi-list' }} {{ icon_color }} text-lg"></i>
                {{ form.categoria|add_class:"w-full p-3 bg-transparent ml-3" }}
              </div>
            </div>
            {% if form.categoria.errors %}<p class="mt-1 text-xs text-red-600">{% for e in form.categoria.errors %}{{ e }} {% endfor %}</p>{% endif %}
          </div>
        </div>

        {# PROVEEDOR + MARCA #}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">{{ form.proveedor.label }}</label>
            <div class="bg-white border rounded-lg shadow-sm px-3 py-2 flex items-center">
              <i class="{{ form.proveedor.field.widget.attrs.icon|default:'bi bi-people' }} {{ icon_color }} text-lg"></i>
              {{ form.proveedor|add_class:"w-full p-0 bg-transparent ml-3" }}
            </div>
            {% if form.proveedor.errors %}<p class="mt-1 text-xs text-red-600">{% for e in form.proveedor.errors %}{{ e }} {% endfor %}</p>{% endif %}
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-2">{{ form.marca.label }}</label>
            <div class="bg-white border rounded-lg shadow-sm px-3 py-2 flex items-center">
              <i class="{{ form.marca.field.widget.attrs.icon|default:'bi bi-award' }} {{ icon_color }} text-lg"></i>
              {{ form.marca|add_class:"w-full p-0 bg-transparent ml-3" }}
            </div>
            {% if form.marca.errors %}<p class="mt-1 text-xs text-red-600">{% for e in form.marca.errors %}{{ e }} {% endfor %}</p>{% endif %}
          </div>
        </div>

        {# EN OFERTA + PRECIO OFERTA #}
        <div class="bg-white border rounded-lg p-4 flex flex-col md:flex-row md:items-center md:gap-6">
          <div class="flex items-center gap-3">
            <label class="inline-flex items-center cursor-pointer">
              {{ form.en_oferta|add_class:"h-5 w-5" }}
              <span class="ml-2 text-sm text-gray-700">{{ form.en_oferta.label }}</span>
            </label>
          </div>

          <div id="precioOfertaWrap" class="w-full md:w-1/3 transition-opacity duration-200 ease-in-out">
            <label class="block text-xs font-medium text-gray-600 mb-2">{{ form.precio_oferta.label }}</label>
            <div class="bg-white border rounded-lg shadow-sm">
              <div class="flex items-center px-3 py-2">
                <i class="{{ form.precio_oferta.field.widget.attrs.icon|default:'bi bi-tags' }} {{ icon_color }} text-lg"></i>
                {{ form.precio_oferta|add_class:"w-full p-2 bg-transparent ml-3 precio-input" }}
              </div>
            </div>
            {% if form.precio_oferta.errors %}<p class="mt-1 text-xs text-red-600">{% for e in form.precio_oferta.errors %}{{ e }} {% endfor %}</p>{% endif %}
          </div>
        </div>

        {# CATALOGO (pills) #}
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">¿Es del catálogo?</label>
          <div class="inline-flex rounded-full bg-gray-100 p-1 gap-1">
            <label class="cursor-pointer">
              <input type="radio" name="catalogo" id="catalogo" value="catalogo" class="sr-only peer" {% if form.catalogo.value == 'catalogo' %}checked{% endif %}>
              <span class="px-4 py-2 text-sm rounded-full border border-transparent peer-checked:bg-emerald-600 peer-checked:text-white">Catálogo</span>
            </label>
            <label class="cursor-pointer">
              <input type="radio" name="catalogo" id="no_catalogo" value="no_catalogo" class="sr-only peer" {% if form.catalogo.value == 'no_catalogo' %}checked{% endif %}>
              <span class="px-4 py-2 text-sm rounded-full border border-transparent peer-checked:bg-emerald-600 peer-checked:text-white">No catálogo</span>
            </label>
          </div>
        </div>

        {# VARIANTES (formset) #}
        <section class="mt-4">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">Variantes</h2>

          <div id="variants-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {# management form OBLIGATORIO (dentro del <form>) #}
            {{ formset.management_form }}

            {% for subform in formset %}
              <div class="bg-white border rounded-lg p-3 shadow-sm formset-form">
                {# Hidden fields (id, DELETE...) #}
                <div class="hidden">
                  {% for hf in subform.hidden_fields %}
                    {{ hf }}
                  {% endfor %}
                </div>

                <div class="flex items-center justify-between mb-2">
                  <strong class="text-sm text-gray-700">Variante {{ forloop.counter }}</strong>
                  <button type="button" class="remove-form text-sm text-red-600">Eliminar</button>
                </div>

                {% if subform.non_field_errors %}
                  <p class="text-xs text-red-600">{% for e in subform.non_field_errors %}{{ e }} {% endfor %}</p>
                {% endif %}

                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <label class="text-xs text-gray-600">Talla</label>
                    <div class="flex items-center">
                      <i class="{{ subform.talla.field.widget.attrs.icon|default:'bi bi-rulers' }} {{ icon_color }} mr-2"></i>
                      {{ subform.talla|add_class:"w-full p-2 bg-gray-50 rounded border" }}
                    </div>
                    {% if subform.talla.errors %}<p class="text-xs text-red-600">{% for e in subform.talla.errors %}{{ e }} {% endfor %}</p>{% endif %}
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Color</label>
                    <div class="flex items-center">
                      <i class="{{ subform.color.field.widget.attrs.icon|default:'bi bi-droplet' }} {{ icon_color }} mr-2"></i>
                      {{ subform.color|add_class:"w-full p-2 bg-gray-50 rounded border" }}
                    </div>
                    {% if subform.color.errors %}<p class="text-xs text-red-600">{% for e in subform.color.errors %}{{ e }} {% endfor %}</p>{% endif %}
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Género</label>
                    <div class="flex items-center">
                      <i class="{{ subform.genero.field.widget.attrs.icon|default:'bi bi-gender-ambiguous' }} {{ icon_color }} mr-2"></i>
                      {{ subform.genero|add_class:"w-full p-2 bg-gray-50 rounded border" }}
                    </div>
                    {% if subform.genero.errors %}<p class="text-xs text-red-600">{% for e in subform.genero.errors %}{{ e }} {% endfor %}</p>{% endif %}
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Cantidad</label>
                    <div class="flex items-center">
                      <i class="{{ subform.cantidad.field.widget.attrs.icon|default:'bi bi-box-seam' }} {{ icon_color }} mr-2"></i>
                      {{ subform.cantidad|add_class:"w-full p-2 bg-gray-50 rounded border" }}
                    </div>
                    {% if subform.cantidad.errors %}<p class="text-xs text-red-600">{% for e in subform.cantidad.errors %}{{ e }} {% endfor %}</p>{% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="mt-3">
            <button type="button" id="add-formset" class="inline-flex items-center gap-2 px-4 py-2 bg-white border rounded-md shadow-sm hover:shadow">
              Añadir variante
            </button>
          </div>

          {# TEMPLATE OCULTO (empty_form) #}
          <template id="empty-form-template">
            <div class="bg-white border rounded-lg p-3 shadow-sm formset-form">
              <div class="hidden">
                {% for hf in formset.empty_form.hidden_fields %}
                  {{ hf }}
                {% endfor %}
              </div>

              <div class="flex items-center justify-between mb-2">
                <strong class="text-sm text-gray-700">Variante __num__</strong>
                <button type="button" class="remove-form text-sm text-red-600">Eliminar</button>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-gray-600">Talla</label>
                  <div class="flex items-center">
                    <i class="{{ formset.empty_form.talla.field.widget.attrs.icon|default:'bi bi-rulers' }} {{ icon_color }} mr-2"></i>
                    {{ formset.empty_form.talla }}
                  </div>
                </div>
                <div>
                  <label class="text-xs text-gray-600">Color</label>
                  <div class="flex items-center">
                    <i class="{{ formset.empty_form.color.field.widget.attrs.icon|default:'bi bi-droplet' }} {{ icon_color }} mr-2"></i>
                    {{ formset.empty_form.color }}
                  </div>
                </div>
                <div>
                  <label class="text-xs text-gray-600">Género</label>
                  <div class="flex items-center">
                    <i class="{{ formset.empty_form.genero.field.widget.attrs.icon|default:'bi bi-gender-ambiguous' }} {{ icon_color }} mr-2"></i>
                    {{ formset.empty_form.genero }}
                  </div>
                </div>
                <div>
                  <label class="text-xs text-gray-600">Cantidad</label>
                  <div class="flex items-center">
                    <i class="{{ formset.empty_form.cantidad.field.widget.attrs.icon|default:'bi bi-box-seam' }} {{ icon_color }} mr-2"></i>
                    {{ formset.empty_form.cantidad }}
                  </div>
                </div>
              </div>
            </div>
          </template>

        </section>

      </div>

      <!-- Panel lateral (1/3) mejorado: previews + nombres editables + manejo de clears (sin usar el widget ClearableFileInput de Django) -->
      <aside class="space-y-4">
        <!-- Imagen principal -->
        <div class="bg-white border rounded-lg p-4 shadow-sm">
          <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.imagen1.label }}</label>

          <div class="flex flex-col items-center gap-3">
            <div id="preview1" class="w-40 h-40 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border">
              {% if object and object.imagen1 %}
                <img src="{{ object.imagen1.url }}" alt="Imagen 1" id="preview1img" class="object-cover w-full h-full">
              {% else %}
                <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h2l3 9h8l3-9h2"/>
                </svg>
              {% endif %}
            </div>

            {# input file MANUAL (mismo name/id que Django espera) #}
            <input type="file" name="{{ form.imagen1.name }}" id="id_imagen1" class="hidden" accept="image/*">

            <div class="w-full flex items-center gap-2">
              <label for="id_imagen1" class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-gray-200 bg-white cursor-pointer hover:shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v8M8 8l4-4 4 4"/>
                </svg>
                <span class="text-sm">Subir imagen</span>
              </label>

              <button type="button" id="removeImagen1Btn" class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-red-200 text-red-600 bg-white hover:bg-red-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-.894.553L4 4H2a1 1 0 100 2h1l1 10a2 2 0 002 2h6a2 2 0 002-2l1-10h1a1 1 0 100-2h-2l-1.106-1.447A1 1 0 0014 2H6zm3 5a1 1 0 012 0v6a1 1 0 11-2 0V7z" clip-rule="evenodd"/>
                </svg>
                <span class="text-sm">Eliminar</span>
              </button>
            </div>

            <!-- filename display (truncado para evitar overflow) -->
            <div class="w-full flex items-center justify-between gap-2 mt-1 min-w-0">
              <div class="w-full overflow-hidden min-w-0">
                <span id="imagen1-filename"
                      class="block text-xs text-gray-700 truncate max-w-[14rem]"
                      title="{% if object and object.imagen1 %}{{ object.imagen1.name }}{% endif %}">
                  {% if object and object.imagen1 %}{{ object.imagen1.name }}{% else %}Sin archivo{% endif %}
                </span>
                <input type="text" id="imagen1-filename-input" class="w-full mt-1 text-xs p-1 border rounded hidden max-w-[14rem] truncate" />
              </div>
            </div>

            <input type="hidden" name="imagen1-clear" id="id_imagen1_clear" value="">
            {% if form.imagen1.errors %}<p class="text-xs text-red-600">{% for e in form.imagen1.errors %}{{ e }}{% endfor %}</p>{% endif %}
          </div>
        </div>

        <!-- Imágenes secundarias: usamos el mismo patrón (input file manual + preview + hidden clear) -->
        <div class="bg-white border rounded-lg p-4 shadow-sm">
          <label class="block text-sm font-medium text-gray-700 mb-2">Imágenes secundarias</label>

          <!-- IMAGEN 2 -->
          <div class="flex flex-col items-start gap-2 mb-2">
            <div class="w-full bg-gray-50 rounded border p-2 flex items-center gap-2 min-w-0">
              <div id="preview2" class="w-20 h-20 bg-gray-100 rounded overflow-hidden flex items-center justify-center">
                {% if object and object.imagen2 %}
                  <img src="{{ object.imagen2.url }}" id="preview2img" class="object-cover w-full h-full">
                {% else %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h2l3 9h8l3-9h2"/></svg>
                {% endif %}
              </div>

              {# input file manual: el name debe coincidir con el campo del form #}
              <input type="file" name="{{ form.imagen2.name }}" id="id_imagen2" class="hidden" accept="image/*">

              <div class="flex flex-col w-full min-w-0">
                <label for="id_imagen2" class="inline-flex items-center gap-2 px-3 py-1 rounded-md border border-gray-200 bg-white cursor-pointer hover:shadow-sm text-xs">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v8M8 8l4-4 4 4"/></svg>
                  Subir
                </label>

                <div class="mt-1 flex items-center justify-between gap-2 min-w-0">
                  <div class="flex gap-2 items-center min-w-0">
                    <button type="button" id="removeImagen2Btn" class="inline-flex items-center gap-2 px-2 py-1 rounded-md border border-red-200 text-red-600 bg-white hover:bg-red-50 text-xs">Eliminar</button>
                    <input type="hidden" name="imagen2-clear" id="id_imagen2_clear" value="">
                  </div>

                  <div class="w-36 text-right min-w-0">
                    <span id="imagen2-filename" class="block text-xs text-gray-700 truncate max-w-[10rem]" title="{% if object and object.imagen2 %}{{ object.imagen2.name }}{% endif %}">
                      {% if object and object.imagen2 %}{{ object.imagen2.name }}{% else %}Sin archivo{% endif %}
                    </span>
                    <input type="text" id="imagen2-filename-input" class="w-full mt-1 text-xs p-1 border rounded hidden max-w-[12rem] truncate" />
                    <input type="hidden" name="imagen2_filename" id="imagen2_filename_hidden" value="">
                  </div>
                </div>
              </div>
            </div>
            {% if form.imagen2.errors %}<p class="text-xs text-red-600">{% for e in form.imagen2.errors %}{{ e }}{% endfor %}</p>{% endif %}
          </div>

          <!-- IMAGEN 3 -->
          <div class="flex flex-col items-start gap-2 mb-2">
            <div class="w-full bg-gray-50 rounded border p-2 flex items-center gap-2 min-w-0">
              <div id="preview3" class="w-20 h-20 bg-gray-100 rounded overflow-hidden flex items-center justify-center">
                {% if object and object.imagen3 %}
                  <img src="{{ object.imagen3.url }}" id="preview3img" class="object-cover w-full h-full">
                {% else %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h2l3 9h8l3-9h2"/></svg>
                {% endif %}
              </div>

              <input type="file" name="{{ form.imagen3.name }}" id="id_imagen3" class="hidden" accept="image/*">

              <div class="flex flex-col w-full min-w-0">
                <label for="id_imagen3" class="inline-flex items-center gap-2 px-3 py-1 rounded-md border border-gray-200 bg-white cursor-pointer hover:shadow-sm text-xs">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v8M8 8l4-4 4 4"/></svg>
                  Subir
                </label>

                <div class="mt-1 flex items-center justify-between gap-2 min-w-0">
                  <div class="flex gap-2 items-center min-w-0">
                    <button type="button" id="removeImagen3Btn" class="inline-flex items-center gap-2 px-2 py-1 rounded-md border border-red-200 text-red-600 bg-white hover:bg-red-50 text-xs">Eliminar</button>
                    <input type="hidden" name="imagen3-clear" id="id_imagen3_clear" value="">
                  </div>

                  <div class="w-36 text-right min-w-0">
                    <span id="imagen3-filename" class="block text-xs text-gray-700 truncate max-w-[10rem]" title="{% if object and object.imagen3 %}{{ object.imagen3.name }}{% endif %}">
                      {% if object and object.imagen3 %}{{ object.imagen3.name }}{% else %}Sin archivo{% endif %}
                    </span>
                    <input type="text" id="imagen3-filename-input" class="w-full mt-1 text-xs p-1 border rounded hidden max-w-[12rem] truncate" />
                    <input type="hidden" name="imagen3_filename" id="imagen3_filename_hidden" value="">
                  </div>
                </div>
              </div>
            </div>
            {% if form.imagen3.errors %}<p class="text-xs text-red-600">{% for e in form.imagen3.errors %}{{ e }}{% endfor %}</p>{% endif %}
          </div>

          <!-- IMAGEN 4 -->
          <div class="flex flex-col items-start gap-2 mb-2">
            <div class="w-full bg-gray-50 rounded border p-2 flex items-center gap-2 min-w-0">
              <div id="preview4" class="w-20 h-20 bg-gray-100 rounded overflow-hidden flex items-center justify-center">
                {% if object and object.imagen4 %}
                  <img src="{{ object.imagen4.url }}" id="preview4img" class="object-cover w-full h-full">
                {% else %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h2l3 9h8l3-9h2"/></svg>
                {% endif %}
              </div>

              <input type="file" name="{{ form.imagen4.name }}" id="id_imagen4" class="hidden" accept="image/*">

              <div class="flex flex-col w-full min-w-0">
                <label for="id_imagen4" class="inline-flex items-center gap-2 px-3 py-1 rounded-md border border-gray-200 bg-white cursor-pointer hover:shadow-sm text-xs">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v8M8 8l4-4 4 4"/></svg>
                  Subir
                </label>

                <div class="mt-1 flex items-center justify-between gap-2 min-w-0">
                  <div class="flex gap-2 items-center min-w-0">
                    <button type="button" id="removeImagen4Btn" class="inline-flex items-center gap-2 px-2 py-1 rounded-md border border-red-200 text-red-600 bg-white hover:bg-red-50 text-xs">Eliminar</button>
                    <input type="hidden" name="imagen4-clear" id="id_imagen4_clear" value="">
                  </div>

                  <div class="w-36 text-right min-w-0">
                    <span id="imagen4-filename" class="block text-xs text-gray-700 truncate max-w-[10rem]" title="{% if object and object.imagen4 %}{{ object.imagen4.name }}{% endif %}">
                      {% if object and object.imagen4 %}{{ object.imagen4.name }}{% else %}Sin archivo{% endif %}
                    </span>
                    <input type="text" id="imagen4-filename-input" class="w-full mt-1 text-xs p-1 border rounded hidden max-w-[12rem] truncate" />
                    <input type="hidden" name="imagen4_filename" id="imagen4_filename_hidden" value="">
                  </div>
                </div>
              </div>
            </div>
            {% if form.imagen4.errors %}<p class="text-xs text-red-600">{% for e in form.imagen4.errors %}{{ e }}{% endfor %}</p>{% endif %}
          </div>

          <!-- IMAGEN 5 -->
          <div class="flex flex-col items-start gap-2 mb-2">
            <div class="w-full bg-gray-50 rounded border p-2 flex items-center gap-2 min-w-0">
              <div id="preview5" class="w-20 h-20 bg-gray-100 rounded overflow-hidden flex items-center justify-center">
                {% if object and object.imagen5 %}
                  <img src="{{ object.imagen5.url }}" id="preview5img" class="object-cover w-full h-full">
                {% else %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h2l3 9h8l3-9h2"/></svg>
                {% endif %}
              </div>

              <input type="file" name="{{ form.imagen5.name }}" id="id_imagen5" class="hidden" accept="image/*">

              <div class="flex flex-col w-full min-w-0">
                <label for="id_imagen5" class="inline-flex items-center gap-2 px-3 py-1 rounded-md border border-gray-200 bg-white cursor-pointer hover:shadow-sm text-xs">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12v8M8 8l4-4 4 4"/></svg>
                  Subir
                </label>

                <div class="mt-1 flex items-center justify-between gap-2 min-w-0">
                  <div class="flex gap-2 items-center min-w-0">
                    <button type="button" id="removeImagen5Btn" class="inline-flex items-center gap-2 px-2 py-1 rounded-md border border-red-200 text-red-600 bg-white hover:bg-red-50 text-xs">Eliminar</button>
                    <input type="hidden" name="imagen5-clear" id="id_imagen5_clear" value="">
                  </div>

                  <div class="w-36 text-right min-w-0">
                    <span id="imagen5-filename" class="block text-xs text-gray-700 truncate max-w-[10rem]" title="{% if object and object.imagen5 %}{{ object.imagen5.name }}{% endif %}">
                      {% if object and object.imagen5 %}{{ object.imagen5.name }}{% else %}Sin archivo{% endif %}
                    </span>
                    <input type="text" id="imagen5-filename-input" class="w-full mt-1 text-xs p-1 border rounded hidden max-w-[12rem] truncate" />
                    <input type="hidden" name="imagen5_filename" id="imagen5_filename_hidden" value="">
                  </div>
                </div>
              </div>
            </div>
            {% if form.imagen5.errors %}<p class="text-xs text-red-600">{% for e in form.imagen5.errors %}{{ e }}{% endfor %}</p>{% endif %}
          </div>

          <div class="bg-white border rounded-lg p-4 text-xs text-gray-600">
            <strong class="text-sm text-gray-800">Consejos</strong>
            <ul class="mt-2 space-y-1">
              <li>- Usa imágenes cuadradas para mejor resultado.</li>
              <li>- Los nombres largos se truncan en la vista; pasa el cursor para ver el nombre completo.</li>
            </ul>
          </div>
        </div>
      </aside>

    </div>

    <!-- Botón fijo para móviles -->
    <div class="fixed bottom-4 right-4 sm:hidden z-40">
      <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg shadow-lg">Guardar</button>
    </div>

  </form>
</div>

<script src="{% static 'js/formato.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  /* -------------------------
     Toggle: precio oferta
     ------------------------- */
  const enOferta = document.getElementById('id_en_oferta');
  const precioOfertaWrap = document.getElementById('precioOfertaWrap');
  if (enOferta && precioOfertaWrap) {
    const toggleOferta = () => {
      if (enOferta.checked) precioOfertaWrap.classList.remove('opacity-50','pointer-events-none');
      else precioOfertaWrap.classList.add('opacity-50','pointer-events-none');
    };
    toggleOferta();
    enOferta.addEventListener('change', toggleOferta);
  }

  /* =========================
     IMÁGENES (preview + clear)
     ========================= */
  const $id = (s) => document.getElementById(s);

  function initImage(idx) {
    const input = $id('id_imagen' + idx);
    const preview = $id('preview' + idx);
    const removeBtn = $id('removeImagen' + idx + 'Btn');
    const clearHidden = $id('id_imagen' + idx + '_clear');
    const filenameSpan = $id(idx === 1 ? 'imagen1-filename' : ('imagen' + idx + '-filename'));
    const filenameHidden = $id(idx === 1 ? 'imagen1_filename_hidden' : ('imagen' + idx + '_filename_hidden'));
    const filenameInput = $id(idx === 1 ? 'imagen1-filename-input' : ('imagen' + idx + '-filename-input'));
    const editBtn = document.querySelector('.imagen-edit-btn[data-target="' + idx + '"]');
    const saveBtn = document.querySelector('.imagen-save-btn[data-target="' + idx + '"]');

    const setPlaceholder = () => {
      if (!preview) return;
      preview.style.display = '';
      preview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h2l3 9h8l3-9h2"/></svg>';
    };

    const previewHasServerImage = () => {
      if (!preview) return false;
      const img = preview.querySelector('img');
      return !!(img && img.src && img.src.trim() !== '');
    };

    const refreshRemoveButton = () => {
      if (!removeBtn) return;
      const hasFile = input && input.files && input.files.length > 0;
      const hasServer = previewHasServerImage();
      if (hasFile || hasServer) {
        removeBtn.disabled = false;
        removeBtn.classList.remove('opacity-50','pointer-events-none');
      } else {
        removeBtn.disabled = true;
        removeBtn.classList.add('opacity-50','pointer-events-none');
      }
    };

    // Cambio de archivo: mostrar preview, título y limpiar marca clear
    if (input) {
      input.addEventListener('change', function () {
        const file = input.files && input.files[0];
        if (!file) {
          // si quitó la selección
          if (filenameSpan) { filenameSpan.textContent = 'Sin archivo'; filenameSpan.title = ''; }
          if (filenameHidden) filenameHidden.value = '';
          refreshRemoveButton();
          return;
        }
        const reader = new FileReader();
        reader.onload = function (ev) {
          if (preview) {
            preview.innerHTML = '';
            const img = document.createElement('img');
            img.className = 'object-cover w-full h-full';
            img.src = ev.target.result;
            preview.appendChild(img);
            preview.style.display = '';
          }
          if (clearHidden) clearHidden.value = '';
          if (filenameSpan) { filenameSpan.textContent = file.name; filenameSpan.title = file.name; }
          if (filenameHidden) filenameHidden.value = file.name;
          if (filenameInput) filenameInput.value = file.name;
          refreshRemoveButton();
        };
        reader.readAsDataURL(file);
      });
    }

    // Botón eliminar: marcar clear="on", limpiar preview y archivo seleccionado (no se puede restaurar file input)
    if (removeBtn) {
      removeBtn.addEventListener('click', function () {
        if (removeBtn.disabled) return;
        if (!confirm('¿Eliminar esta imagen? Al guardar se eliminará del servidor.')) return;
        const prevImg = preview ? (preview.querySelector('img') ? preview.querySelector('img').src : null) : null;
        if (clearHidden) clearHidden.value = 'on';
        if (input) { try { input.value = ''; } catch(e) {} }
        if (preview) { preview.innerHTML = ''; preview.style.display = 'none'; }
        if (filenameSpan) { filenameSpan.textContent = 'Sin archivo'; filenameSpan.title = ''; }
        if (filenameHidden) filenameHidden.value = '';
        // (no undo UI aquí) refrescar estado del botón
        refreshRemoveButton();
      });
    }

    // Edición simple de nombre (solo si existen los controles en DOM)
    if (editBtn && saveBtn && filenameSpan && filenameInput && filenameHidden) {
      editBtn.addEventListener('click', function () {
        filenameSpan.classList.add('hidden');
        filenameInput.classList.remove('hidden');
        editBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
        filenameInput.focus();
        filenameInput.select();
      });
      saveBtn.addEventListener('click', function () {
        const newName = (filenameInput.value || '').trim();
        filenameSpan.textContent = newName || 'Sin archivo';
        filenameSpan.title = newName || '';
        filenameSpan.classList.remove('hidden');
        filenameInput.classList.add('hidden');
        editBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
        filenameHidden.value = newName;
      });
    }

    // init
    refreshRemoveButton();
  }

  [1,2,3,4,5].forEach(initImage);

  /* =========================
     FORMSET: añadir / eliminar
     ========================= */
  const addBtn = document.getElementById('add-formset');
  const grid = document.getElementById('variants-grid');
  const emptyTemplate = document.getElementById('empty-form-template');
  const totalFormsInput = document.querySelector("input[name$='-TOTAL_FORMS']");

  const getTotalForms = () => totalFormsInput ? parseInt(totalFormsInput.value || '0', 10) : 0;
  const setTotalForms = (n) => { if (totalFormsInput) totalFormsInput.value = String(n); };

  if (addBtn && emptyTemplate && grid && totalFormsInput) {
    addBtn.addEventListener('click', function () {
      const index = getTotalForms();
      const cloneHtml = emptyTemplate.innerHTML.replace(/__prefix__/g, index).replace(/__num__/g, index+1);
      const tmp = document.createElement('div');
      tmp.innerHTML = cloneHtml;
      const newCard = tmp.firstElementChild;
      // limpiar inputs visibles
      newCard.querySelectorAll('input, select, textarea').forEach(i => {
        if (i.type === 'checkbox' || i.type === 'radio') i.checked = false;
        else if (i.type !== 'hidden') i.value = '';
      });
      grid.appendChild(newCard);
      setTotalForms(getTotalForms() + 1);
      // actualizar numeración visual
      refreshFormsetNumbers();
    });
  }

  // eliminar variante (delegación). Si instancia existe: marcar DELETE + ocultar.
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.remove-form');
    if (!btn) return;
    const card = btn.closest('.formset-form');
    if (!card) return;

    const idInput = card.querySelector("input[name$='-id']");
    const deleteInput = card.querySelector("input[name$='-DELETE']");

    if (idInput && idInput.value) {
      // marcar para borrado y ocultar visualmente (no eliminar inputs)
      if (deleteInput) {
        if (deleteInput.type === 'checkbox') deleteInput.checked = true;
        else deleteInput.value = 'on';
      } else {
        const h = document.createElement('input');
        h.type = 'hidden';
        h.name = idInput.name.replace(/-id$/, '-DELETE');
        h.value = 'on';
        card.appendChild(h);
      }
      card.style.display = 'none';
    } else {
      // form nuevo: eliminar del DOM y decrementar TOTAL_FORMS
      card.remove();
      setTotalForms(getTotalForms() - 1);
      refreshFormsetNumbers();
    }
  });

  // renumerar etiquetas "Variante N"
  function refreshFormsetNumbers() {
    const cards = Array.from(document.querySelectorAll('.formset-form'));
    cards.forEach((card, idx) => {
      const strong = card.querySelector('strong');
      if (strong) strong.textContent = 'Variante ' + (idx + 1);
      // además actualizar names/ids dentro de cada card (opcional, pero evita confusiones si reenvías)
      card.querySelectorAll('input, select, textarea, label').forEach(el => {
        if (el.name) el.name = el.name.replace(/-\d+-/g, `-${idx}-`).replace(/__prefix__/g, String(idx));
        if (el.id) el.id = el.id.replace(/-\d+-/g, `-${idx}-`).replace(/__prefix__/g, String(idx));
        if (el.getAttribute && el.getAttribute('for')) {
          el.setAttribute('for', el.getAttribute('for').replace(/-\d+-/g, `-${idx}-`).replace(/__prefix__/g, String(idx)));
        }
      });
    });
  }

  // inicial: asegurar numeración correcta si vienen forms del servidor
  refreshFormsetNumbers();

});
</script>

{% endblock %}
{% endwith %}
