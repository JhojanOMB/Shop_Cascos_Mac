{% extends 'base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<style>
/* --------------------
  Ajustes para evitar overflow en tablas (variantes y detalleModal)
   -------------------- */

/* Wrapper general ya usado en tus tablas: permite scroll horizontal si hace falta */
.table-wrapper {
  width: 100%;
  overflow-x: auto;
}

/* Tablas de variantes en la lista principal */
.variantes-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto; /* importante: dejar que la tabla ajuste columnas */
}

/* Celdas flexibles: permiten romper líneas y no desbordar */
.variantes-table th,
.variantes-table td,
.detalle-table th,
.detalle-table td {
  white-space: normal !important;      /* permitir saltos de línea */
  word-break: break-word !important;   /* romper palabras largas si hace falta */
  overflow-wrap: anywhere !important;  /* forzar quiebre donde sea necesario */
  max-width: 1px;                      /* combinado con word-break obliga el salto */
  padding: 0.35rem 0.5rem;
  vertical-align: middle;
}

/* Evitar que filas muy largas estiren el layout: */
.variantes-table td,
.detalle-table td {
  min-width: 0; /* necesario en flex/grid para que no empuje el contenedor */
}

/* Detalle modal: permitir scroll interno y no forzar min-width */
#cantidadModal .modal-body-scroll {
  max-height: 72vh;
  overflow-y: auto;
  padding-right: 0.5rem;
}

/* NO usar min-width fijo en la tabla del modal (antes tenías 420px) */
#cantidadModal .detalle-table {
  table-layout: auto !important;
  width: 100% !important;
  min-width: 0 !important;
}

/* Imágenes: que no estiren la celda */
#cantidadModal .table-img img,
#cantidadModal img {
  max-width: 120px !important;
  max-height: 100px !important;
  height: auto;
  object-fit: contain;
}

/* Wrapper de la tabla (ya tienes overflow-x-auto en algunos sitios, 
   uniformizamos con esta clase para aplicarla donde haga falta) */
.usa-scroll {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* Ajustes responsive: en móviles apilar (si quieres que se vea vertical) */
@media (max-width: 640px) {
  .card-grid { grid-template-columns: 1fr !important; }
  .variantes-table th, .variantes-table td, .detalle-table th, .detalle-table td {
    font-size: 0.85rem;
  }
}
</style>
    
<form method="POST" id="formulario">
    {% csrf_token %}
    <button type="button" id="btnActualizarTodosCodigosBarras" class="inline-flex items-center gap-2 px-3 py-1 bg-gray-800 text-white text-sm rounded">Actualizar Todos los Códigos de Barras</button>
</form>

<!-- Controles de filtro y búsqueda mejorados (icono no tapa input + responsive) -->
<div class="mt-6 p-4 bg-white rounded-xl shadow-md border border-gray-200">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">

    <!-- BTN CREAR -->
    <a href="{% url 'crear_producto' %}"
       class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm px-4 py-2 rounded-lg shadow-sm transition">
      <i class="fa-solid fa-plus"></i> Crear producto
    </a>

    <!-- FORMULARIO DE FILTROS: en móvil columna, en sm row -->
    <form method="get" class="flex flex-col sm:flex-row sm:items-center gap-3 w-full sm:w-auto">

      <!-- BUSCADOR: full width en móvil, width fijo en sm+ -->
    <div class="relative w-full md:w-64">
        <span class="absolute inset-y-0 left-3 flex items-center text-gray-400 pointer-events-none">
            <i class="fa-solid fa-magnifying-glass text-sm"></i>
        </span>

        <input 
            type="text" 
            name="q" 
            placeholder="Buscar producto..." 
            value="{{ request.GET.q }}" 
            class="w-full border border-gray-300 rounded-lg pl-10 pr-3 py-2 text-sm 
                focus:outline-none focus:ring-2 focus:ring-indigo-300"
        >
    </div>

      <!-- FILTRO CATEGORÍA -->
      <div class="w-full sm:w-48">
        <select
          name="categoria"
          id="category-filter"
          class="block w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 transition"
        >
          <option value="">Categoría</option>
          {% for categoria in categorias %}
            <option value="{{ categoria.id }}" {% if request.GET.categoria|stringformat:"s" == categoria.id|stringformat:"s" %}selected{% endif %}>
              {{ categoria.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- FILTRO PROVEEDOR -->
      <div class="w-full sm:w-48">
        <select
          name="proveedor"
          id="provider-filter"
          class="block w-full border border-gray-300 rounded-lg px-3 py-2 text-sm bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 transition"
        >
          <option value="">Proveedor</option>
          {% for proveedor in proveedores %}
            <option value="{{ proveedor.id }}" {% if request.GET.proveedor|stringformat:"s" == proveedor.id|stringformat:"s" %}selected{% endif %}>
              {{ proveedor.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- BOTONES: en móvil se apilan, en sm se alinean a la derecha del form -->
      <div class="flex w-full sm:w-auto flex-col sm:flex-row sm:items-center gap-2">
        <button type="submit"
          class="inline-flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-4 py-2 rounded-lg shadow-sm transition w-full sm:w-auto">
          <i class="fa-solid fa-filter"></i> Buscar
        </button>

        <a href="{% url 'contenido_productos' %}"
          class="inline-flex items-center justify-center gap-2 bg-gray-800 hover:bg-gray-700 text-white text-sm px-4 py-2 rounded-lg shadow-sm transition w-full sm:w-auto">
          <i class="fa-solid fa-rotate-right"></i> Limpiar
        </a>
      </div>

    </form>
  </div>
</div>


<form method="post" action="{% url 'eliminar_productos_seleccionados' %}" class="mt-4">
    {% csrf_token %}

    <div class="flex items-center gap-2 mb-3">
        <button type="button" id="open-confirm-modal" class="bg-red-600 hover:bg-red-500 text-white text-sm px-3 py-1 rounded" disabled>Eliminar seleccionados</button>

        <a href="{% url 'imprimir_codigos' %}" id="btn-imprimir" class="bg-emerald-600 hover:bg-emerald-500 text-white text-sm px-3 py-1 rounded inline-flex items-center gap-2" role="button">
            <i class="fa-solid fa-print"></i> Imprimir códigos
        </a>
    </div>

    <!-- Tabla de productos -->
    <div class="overflow-x-auto bg-white rounded shadow">
    <table class="min-w-full divide-y divide-gray-200 border border-gray-300 border-collapse table-centered text-center">
        <thead class="bg-gray-900 text-white">
                <tr>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">
                        <input type="checkbox" id="select-all" class="h-4 w-4">
                    </th>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">Nombre</th>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">Referencia</th>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">Precio de compra</th>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">Precio de venta</th>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">Categoría</th>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">Códigos de barras</th>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">Tallas / Colores / Géneros</th>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">Stock</th>
                    <th class="px-3 py-2 text-left text-center border border-gray-300">Opciones</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
                {% for producto in productos %}
                <tr id="producto-{{ producto.id }}" class="hover:bg-gray-50 align-middle">
                    <td class="px-3 py-2 border border-gray-300">
                        <input type="checkbox" name="productos_seleccionados" value="{{ producto.id }}" class="select-checkbox h-4 w-4" data-nombre="{{ producto.nombre }}">
                    </td>
                    <td class="px-3 py-2 font-semibold border border-gray-300">{{ producto.nombre }}</td>
                    <td class="px-3 py-2 border border-gray-300">{{ producto.referencia }}</td>
                    <td class="px-3 py-2 border border-gray-300">${{ producto.precio_compra|floatformat:0|intcomma|default:"0" }}</td>
                    <td class="px-3 py-2 border border-gray-300">${{ producto.precio_venta|floatformat:0|intcomma }}</td>
                    <td class="px-3 py-2 border border-gray-300">{{ producto.categoria.nombre }}</td>
                    <td class="px-3 py-2 border border-gray-300">
                        <button type="button" class="w-full border border-gray-300 rounded px-2 py-1 text-sm" data-open-modal="codigoBarrasModal-{{ producto.id }}">
                            <i class="fa-solid fa-barcode text-2xl"></i>
                        </button>
                    </td>

                    <td class="px-3 py-2 border border-gray-300">
                        {% if producto.variantes %}
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm border border-gray-300 border-collapse">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-2 py-1 text-center border border-gray-300">Talla</th>
                                        <th class="px-2 py-1 text-center border border-gray-300">Color</th>
                                        <th class="px-2 py-1 text-center border border-gray-300">Género</th>
                                        <th class="px-2 py-1 text-center border border-gray-300">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for variante in producto.variantes %}
                                    <tr class="text-center">
                                        <td class="px-2 py-1 border border-gray-300">{{ variante.talla.nombre }}</td>
                                        <td class="px-2 py-1 border border-gray-300">{{ variante.color }}</td>
                                        <td class="px-2 py-1 border border-gray-300">{{ variante.get_genero_display }}</td>
                                        <td class="px-2 py-1 border border-gray-300">{{ variante.cantidad }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <span class="text-gray-500 text-sm">Sin variantes disponibles</span>
                        {% endif %}
                    </td>

                    <td class="px-3 py-2 border border-gray-300">{{ producto.total_cantidad }}</td>

                    <td class="px-3 py-2 border border-gray-300">
                        <div class="flex gap-2">
                            <a href="{% url 'editar_producto' producto.pk %}" class="px-2 py-1 border border-indigo-600 rounded text-sm action-btn hover:bg-indigo-50 text-indigo-600/95" title="Editar producto"><i class="fa-solid fa-pen-to-square"></i></a>
                            <a href="{% url 'eliminar_producto' producto.pk %}" class="px-2 py-1 border border-red-600 rounded text-sm action-btn hover:bg-red-50 text-red-600/95" title="Eliminar producto"><i class="fa-solid fa-trash"></i></a>
                            <a href="{% url 'detalles_producto' producto.pk %}" class="px-2 py-1 border border-gray-600 rounded text-sm action-btn hover:bg-gray-100 text-gray-700/95" title="Ver detalles"><i class="fa-solid fa-circle-info"></i></a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal de confirmación de eliminación (Tailwind) -->
    <div id="confirmDeleteModal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/50">
      <div class="bg-white rounded-lg overflow-hidden w-11/12 max-w-lg border-2 border-red-500">
        <div class="p-4 bg-red-600 text-white flex items-center justify-between">
          <h3 class="font-semibold">Confirmar eliminación</h3>
          <button type="button" data-close-modal="confirmDeleteModal" class="text-white text-lg">&times;</button>
        </div>
        <div class="p-4">
          <p class="text-red-700 font-semibold">¿Estás seguro de que deseas eliminar los siguientes productos? <br> Esta acción <strong>no se puede deshacer.</strong></p>
          <ul id="lista-productos-a-eliminar" class="mt-3 space-y-1">
            <!-- Aquí se llenan los nombres -->
          </ul>
        </div>
        <div class="p-4 flex justify-end gap-2">
          <button type="button" data-close-modal="confirmDeleteModal" class="px-3 py-1 border rounded text-sm">Cancelar</button>
          <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded text-sm">Eliminar</button>
        </div>
      </div>
    </div>

</form>

<!-- Paginación inferior -->
<div class="mt-4 flex items-center justify-center">
  <nav class="inline-flex -space-x-px" aria-label="Pagination">
    {% if page_obj.has_previous %}
      <a href="?{% if query_params %}{{ query_params }}&{% endif %}page=1" class="px-3 py-1 border rounded-l bg-white">&laquo; Primero</a>
      <a href="?{% if query_params %}{{ query_params }}&{% endif %}page={{ page_obj.previous_page_number }}" class="px-3 py-1 border bg-white">Anterior</a>
    {% endif %}

    <span class="px-3 py-1 border bg-gray-100">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
      <a href="?{% if query_params %}{{ query_params }}&{% endif %}page={{ page_obj.next_page_number }}" class="px-3 py-1 border bg-white">Siguiente</a>
      <a href="?{% if query_params %}{{ query_params }}&{% endif %}page={{ page_obj.paginator.num_pages }}" class="px-3 py-1 border rounded-r bg-white">Último &raquo;</a>
    {% endif %}
  </nav>
</div>

<!-- Modales por producto (códigos de barras) -->
{% for producto in productos %}
<div id="codigoBarrasModal-{{ producto.id }}" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/50 px-4">
  <div class="bg-white w-full max-w-6xl rounded-lg overflow-hidden">
    <div class="p-4 bg-gray-900 text-white flex items-center justify-between">
      <h3 class="font-semibold">Códigos de barras para: {{ producto.nombre }}</h3>
      <button type="button" data-close-modal="codigoBarrasModal-{{ producto.id }}" class="text-white text-lg">&times;</button>
    </div>
    <div class="p-4">
      {% if producto.producto_tallas.all %}
      <form id="form-imprimir-{{ producto.id }}">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 border border-gray-300 border-collapse">
            <thead class="bg-gray-100 text-sm">
              <tr class="text-center">
                <th class="px-2 py-2 text-center border border-gray-300">Seleccionar</th>
                <th class="px-2 py-2 text-center border border-gray-300">Detalles</th>
                <th class="px-2 py-2 text-center border border-gray-300">Imagen</th>
                <th class="px-2 py-2 text-center border border-gray-300">Código</th>
                <th class="px-2 py-2 text-center border border-gray-300">Referencia</th>
                <th class="px-2 py-2 text-center border border-gray-300">Acciones</th>
              </tr>
            </thead>
            <tbody class="text-sm">
              {% for pt in producto.producto_tallas.all %}
              <tr class="text-center align-middle">
                <td class="px-2 py-2 border border-gray-300">
                  <input type="checkbox" class="imprimir-codigo h-4 w-4 mx-auto" value="{{ pt.codigo_barras }}" data-talla="{{ pt.talla.nombre }}" data-color="{{ pt.color }}" data-genero="{{ pt.genero }}" data-img-url="{% url 'barcode_image_talla' pt.id %}">
                </td>
                <td class="px-2 py-2 border border-gray-300">
  <table class="w-full border border-gray-300 table-auto text-sm">
    <tbody>
      <tr>
        <td class="px-2 py-1 border bg-gray-50 font-medium">Talla</td>
        <td class="px-2 py-1 border">{{ pt.talla.nombre }}</td>
      </tr>
      <tr>
        <td class="px-2 py-1 border bg-gray-50 font-medium">Color</td>
        <td class="px-2 py-1 border">{{ pt.color }}</td>
      </tr>
      <tr>
        <td class="px-2 py-1 border bg-gray-50 font-medium">Género</td>
        <td class="px-2 py-1 border">{{ pt.genero }}</td>
      </tr>
    </tbody>
  </table>
</td>
                <td class="px-2 py-2 border border-gray-300">
                  <img src="{% url 'barcode_image_talla' pt.id %}" alt="Código para la variante {{ pt.codigo_barras }}" class="mx-auto" style="max-height:100px;">
                </td>
                <td class="px-2 py-2 border border-gray-300">
                  <input type="text" class="codigo-barra-text border border-gray-300 rounded px-2 py-1 text-sm w-full" value="{{ pt.codigo_barras }}" readonly>
                </td>
                <td class="px-2 py-2 border border-gray-300">
                  <input type="text" class="referencia-text border border-gray-300 rounded px-2 py-1 text-sm w-full" value="{{ producto.referencia }}" readonly>
                </td>
                <td class="px-2 py-2 border border-gray-300">
                  <button type="button" class="copy-code inline-flex items-center gap-2 px-2 py-1 border rounded text-sm action-btn hover:bg-gray-50 text-gray-700" data-code="{{ pt.codigo_barras }}"><i class="fa-solid fa-copy"></i> Copiar</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>
      {% else %}
        <p class="text-gray-500 text-center">No hay códigos de barras disponibles para este producto.</p>
      {% endif %}
    </div>
    <div class="p-4 flex justify-end gap-2">
      <button type="button" class="px-3 py-1 bg-indigo-600 text-white rounded" onclick="imprimirCodigos('{{ producto.id }}')"><i class="fa-solid fa-print mr-2"></i> Imprimir seleccionados</button>
      <button type="button" data-close-modal="codigoBarrasModal-{{ producto.id }}" class="px-3 py-1 border rounded">Cerrar</button>
    </div>
  </div>
</div>
{% endfor %}

<!-- Submodal para definir cantidades antes de imprimir (único, fuera del loop) -->
<div id="cantidadModal" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center bg-black/50 px-4">
  <div class="w-full max-w-3xl bg-white rounded-t-lg sm:rounded-xl shadow-2xl overflow-hidden ring-1 ring-black/5">
    <!-- Header -->
    <div class="flex items-center justify-between bg-blue-600 text-white p-4">
      <h3 class="text-lg font-semibold">Definir cantidades</h3>
      <button type="button" data-close-modal="cantidadModal" aria-label="Cerrar" class="text-white text-2xl leading-none">&times;</button>
    </div>

    <!-- Body -->
    <div class="p-4 max-h-[72vh] overflow-y-auto space-y-4" id="cantidadModalBody">
      <form id="form-cantidades" class="space-y-4">
        {% csrf_token %}
        <!-- contenedor donde se inyectan las tarjetas -->
        <div id="contenedor-cantidades" class="space-y-4"></div>
      </form>
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-end gap-2 p-4 border-t">
      <button type="button" id="btn-enviar-impresion" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded shadow">
        <i class="fa-solid fa-print"></i> Imprimir
      </button>
      <button type="button" onclick="volverAlModalOriginal()" class="px-4 py-2 border rounded bg-white hover:bg-gray-50">Cancelar</button>
    </div>
  </div>
</div>

<!-- Scripts (mejorados, Tailwind-friendly) -->
<script>
/* ===========================
   Helpers: abrir / cerrar modales
   =========================== */
function abrirModal(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('hidden');
  el.classList.add('flex');
  // bloquear scroll de fondo
  document.body.style.overflow = 'hidden';
}
function cerrarModal(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('hidden');
  el.classList.remove('flex');
  document.body.style.overflow = '';
}

/* ===========================
   Delegación global para abrir/cerrar modales
   =========================== */
document.addEventListener('click', function(e) {
  const open = e.target.closest('[data-open-modal]');
  if (open) {
    const id = open.getAttribute('data-open-modal');
    abrirModal(id);
  }
  const close = e.target.closest('[data-close-modal]');
  if (close) {
    const id = close.getAttribute('data-close-modal');
    cerrarModal(id);
  }
});

/* ===========================
   Copiar al portapapeles (delegación)
   =========================== */
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.copy-code');
  if (!btn) return;
  const code = btn.getAttribute('data-code') || '';
  navigator.clipboard.writeText(code).then(() => {
    const prev = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-check"></i> Copiado';
    btn.classList.add('bg-emerald-500','text-white');
    setTimeout(() => {
      btn.innerHTML = prev;
      btn.classList.remove('bg-emerald-500','text-white');
    }, 1800);
  }).catch(err => {
    console.error('Error al copiar:', err);
    alert('No se pudo copiar el código. Intenta de nuevo.');
  });
});

/* ===========================
   Seleccionar / Eliminar múltiple y actualizar botón
   =========================== */
document.addEventListener('DOMContentLoaded', function() {
  const selectAll = document.getElementById('select-all');
  const openModalBtn = document.getElementById('open-confirm-modal');
  const listaProductos = document.getElementById('lista-productos-a-eliminar');

  function getCheckboxes() { return Array.from(document.querySelectorAll('.select-checkbox')); }

  function toggleDeleteButton() {
    const anyChecked = getCheckboxes().some(cb => cb.checked);
    if (openModalBtn) {
      openModalBtn.disabled = !anyChecked;
      openModalBtn.classList.toggle('opacity-50', !anyChecked);
      openModalBtn.classList.toggle('cursor-not-allowed', !anyChecked);
    }
  }

  if (selectAll) {
    selectAll.addEventListener('change', function () {
      getCheckboxes().forEach(cb => cb.checked = selectAll.checked);
      toggleDeleteButton();
    });
  }

  getCheckboxes().forEach(cb => cb.addEventListener('change', toggleDeleteButton));

  if (openModalBtn) {
    openModalBtn.addEventListener('click', function () {
      listaProductos.innerHTML = '';
      getCheckboxes().forEach(cb => {
        if (cb.checked) {
          const nombre = cb.dataset.nombre || cb.value || 'Producto';
          const li = document.createElement('li');
          li.className = 'py-1 border-b';
          li.textContent = nombre;
          listaProductos.appendChild(li);
        }
      });
      abrirModal('confirmDeleteModal');
    });
  }

  // Botón actualizar todos códigos
  const btnActualizar = document.getElementById('btnActualizarTodosCodigosBarras');
  if (btnActualizar) {
    btnActualizar.addEventListener('click', function() {
      const csrfEl = document.querySelector('[name=csrfmiddlewaretoken]');
      const csrf = csrfEl ? csrfEl.value : '';
      btnActualizar.disabled = true;
      fetch('/tienda/actualizar-todos-codigos-barras/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrf
        },
        body: JSON.stringify({ actualizar: true })
      })
      .then(r => r.json())
      .then(data => {
        if (data && data.errores && data.errores.length) {
          alert('Hubo errores al actualizar algunos códigos. Revisa la consola.');
          console.log(data.errores);
        } else {
          alert('Actualización finalizada.');
          // opcional: recargar para ver cambios
          // location.reload();
        }
      }).catch(err => {
        console.error('Error actualizar códigos:', err);
        alert('Error en la solicitud. Revisa la consola.');
      }).finally(() => { btnActualizar.disabled = false; });
    });
  }
});

/* ===========================
   SUBMODAL: generar tarjetas y lógica de impresión
   =========================== */
window.ultimoModalId = null;

window.imprimirCodigos = function(productoId) {
  const mainModalId = 'codigoBarrasModal-' + productoId;
  const mainModalEl = document.getElementById(mainModalId);
  if (!mainModalEl) {
    alert('No se encontró el modal del producto. Refresca la página e intenta de nuevo.');
    return;
  }

  // Solo checkboxes seleccionados dentro del modal del producto
  const checks = mainModalEl.querySelectorAll('.imprimir-codigo:checked');
  if (!checks || checks.length === 0) {
    alert('Selecciona al menos un código.');
    return;
  }

  // Guardar referencia para volver después y cerrar modal principal
  window.ultimoModalId = mainModalId;
  cerrarModal(mainModalId);

  const cont = document.getElementById('contenedor-cantidades');
  if (!cont) {
    alert('No se encontró el contenedor de cantidades en el submodal.');
    return;
  }
  cont.innerHTML = '';

  // Crear tarjeta por cada checkbox seleccionado
  checks.forEach(cb => {
    const code = cb.value || '';
    const imgRel = cb.dataset.imgUrl || '';
    const imgFull = imgRel.startsWith('http') ? imgRel : (window.location.origin + imgRel);
    const talla = cb.dataset.talla || '';
    const color = cb.dataset.color || '';
    const genero = cb.dataset.genero || '';

    // tarjeta principal
    const tarjeta = document.createElement('div');
    tarjeta.className = 'bg-white shadow-lg border border-gray-200 rounded-lg p-3 flex flex-col sm:flex-row gap-3 items-center';

    // imagen
    const colImg = document.createElement('div');
    colImg.className = 'w-full sm:w-28 flex items-center justify-center';
    const img = document.createElement('img');
    img.src = imgFull;
    img.alt = `Código ${code}`;
    img.className = 'object-contain max-h-28 w-full';
    // usar static correctamente para placeholder (comillas simples dentro del tag)
    img.onerror = function(){ this.src = "{% static 'img/placeholder.png' %}"; };
    colImg.appendChild(img);

    // detalles - tabla compacta con bordes
    const colDet = document.createElement('div');
    colDet.className = 'flex-1 w-full';
    colDet.innerHTML = `
      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-50">
              <th class="text-left text-xs font-semibold px-2 py-1 border border-gray-200">Código</th>
              <th class="text-left text-xs font-semibold px-2 py-1 border border-gray-200">Talla</th>
              <th class="text-left text-xs font-semibold px-2 py-1 border border-gray-200">Color</th>
              <th class="text-left text-xs font-semibold px-2 py-1 border border-gray-200">Género</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="px-2 py-2 border border-gray-200 font-medium break-words">${code}</td>
              <td class="px-2 py-2 border border-gray-200">${talla}</td>
              <td class="px-2 py-2 border border-gray-200">${color}</td>
              <td class="px-2 py-2 border border-gray-200">${genero}</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;

    // cantidad + inputs ocultos
    const colCant = document.createElement('div');
    colCant.className = 'w-full sm:w-36 flex flex-col items-end gap-2';
    const label = document.createElement('label');
    label.className = 'text-sm text-gray-600';
    label.textContent = 'Cantidad';
    const inputNum = document.createElement('input');
    inputNum.type = 'number';
    inputNum.name = 'cantidades[]';
    inputNum.min = '1';
    inputNum.value = '1';
    inputNum.className = 'w-20 border border-gray-300 rounded px-2 py-1 text-right';

    const hiddenCode = document.createElement('input'); hiddenCode.type = 'hidden'; hiddenCode.name = 'codigos[]'; hiddenCode.value = code;
    const hiddenImg = document.createElement('input'); hiddenImg.type = 'hidden'; hiddenImg.name = 'img_urls[]'; hiddenImg.value = imgFull;

    colCant.appendChild(label);
    colCant.appendChild(inputNum);
    colCant.appendChild(hiddenCode);
    colCant.appendChild(hiddenImg);

    // ensamblar tarjeta
    tarjeta.appendChild(colImg);
    tarjeta.appendChild(colDet);
    tarjeta.appendChild(colCant);

    cont.appendChild(tarjeta);
  });

  // abrir submodal (en móvil se ve como bottom-sheet por diseño)
  abrirModal('cantidadModal');

  // foco al primer input
  setTimeout(() => {
    const first = document.querySelector('#cantidadModal input[name="cantidades[]"]');
    if (first) first.focus();
  }, 120);
};

/* volver al modal principal previamente abierto */
window.volverAlModalOriginal = function() {
  cerrarModal('cantidadModal');
  if (window.ultimoModalId) {
    abrirModal(window.ultimoModalId);
    window.ultimoModalId = null;
  }
};

/* ===========================
   Envío del form de cantidades -> genera PDF y lo abre en nueva pestaña
   =========================== */
document.addEventListener('click', function(e) {
  const btn = e.target.closest('#btn-enviar-impresion');
  if (!btn) return;
  btn.disabled = true;
  btn.classList.add('opacity-70','cursor-not-allowed');

  const form = document.getElementById('form-cantidades');
  if (!form) { alert('Formulario no encontrado.'); btn.disabled = false; return; }
  const fd = new FormData(form);

  // CSRF token (desde form o desde la página)
  const csrf = fd.get('csrfmiddlewaretoken') || (document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '');

  fetch('{% url "imprimir_codigos_barras" %}', {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'X-CSRFToken': csrf, 'Accept': 'application/pdf' },
    body: fd
  })
  .then(resp => {
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    return resp.arrayBuffer();
  })
  .then(buf => {
    const blob = new Blob([buf], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  })
  .catch(err => {
    console.error('Error generando PDF:', err);
    alert('No se pudo generar el PDF. Revisa la consola.');
  })
  .finally(() => {
    window.volverAlModalOriginal();
    setTimeout(() => {
      btn.disabled = false;
      btn.classList.remove('opacity-70','cursor-not-allowed');
    }, 900);
  });
});
</script>


{% endblock %}
